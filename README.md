# Metrika Logs Downloader

## Описание
Приложение для выгрузки логов из Яндекс.Метрики через Logs API с графическим интерфейсом пользователя.

## Возможности
- Выгрузка логов посещений (visits) и просмотров (hits)
- Выбор произвольных метрик из доступного списка
- Настройка периода выгрузки
- Поддержка различных форматов дат (today, yesterday, NdaysAgo, YYYY-MM-DD)
- Выбор типа атрибуции
- Сохранение отчетов в CSV формате
- Сохранение установочных данных между сессиями

## Требования
- Python 3.7+
- Установленные зависимости из requirements.txt

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd metrika-logs-apps
```

2. Создайте виртуальное окружение:
```bash
python -m venv .venv
```

3. Активируйте виртуальное окружение:
- Windows:
```bash
.\.venv\Scripts\activate
```
- Linux/Mac:
```bash
source .venv/bin/activate
```

4. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Использование

1. Запустите приложение:
```bash
python main.py
```

2. Заполните обязательные поля:
- OAuth Token - токен для доступа к API Яндекс.Метрики
- Counter ID - идентификатор счётчика
- Login - логин пользователя

3. Настройте параметры отчета:
- Выберите тип отчета (visits/hits)
- Укажите даты начала и конца периода
- Выберите необходимые метрики
- Настройте тип атрибуции при необходимости

4. Нажмите "Загрузить отчет" для получения данных

## Структура проекта

```
metrika-logs-apps/
├── main.py              # Основной файл приложения с GUI
├── api_logic.py         # Логика работы с API Яндекс.Метрики
├── requirements.txt     # Зависимости проекта
├── settings.json        # Файл с сохраненными настройками
└── README.md           # Документация
```

## Основные компоненты

### GUI (main.py)
- Класс `MetrikaApp` - основной класс приложения
- Управление интерфейсом и обработка пользовательских действий
- Сохранение/загрузка настроек
- Валидация входных данных

### API Logic (api_logic.py)
- Работа с Logs API Яндекс.Метрики
- Валидация параметров запросов
- Обработка ответов API
- Сохранение данных в CSV

## GUI Implementation (main.py)

### Используемые библиотеки
- `tkinter` - для создания графического интерфейса
- `ttk` - для стилизованных виджетов
- `logging` - для ведения логов
- `json` - для сохранения/загрузки настроек
- `os` - для работы с путями файлов

### Основной класс MetrikaApp

#### Инициализация и настройка GUI
- `__init__(self, root)`
  - Создание главного окна
  - Инициализация компонентов интерфейса
  - Загрузка сохраненных настроек

- `create_context_menu(self)`
  - Создание контекстного меню
  - Добавление стандартных операций (копировать/вставить)

#### Управление метриками
- `on_report_type_change(self, event=None)`
  - Обработка смены типа отчета
  - Обновление списка доступных метрик

- `add_selected_metrics(self)`
  - Добавление выбранных метрик в отчет
  - Проверка совместимости метрик

- `remove_selected_metrics(self)`
  - Удаление метрик из отчета

#### Работа с данными
- `execute_request(self)`
  - Валидация введенных данных
  - Создание и отправка запроса
  - Обработка результатов

- `save_settings(self)`
  - Сохранение установочных данных
  - Шифрование чувствительной информации

- `load_settings(self)`
  - Загрузка сохраненных настроек
  - Восстановление состояния приложения

#### Вспомогательные функции
- `bind_widget_events(self, widget)`
  - Привязка обработчиков событий
  - Настройка контекстного меню

- `show_context_menu(self, event)`
  - Отображение контекстного меню
  - Обработка действий пользователя

### Компоненты интерфейса

#### Поля ввода
- OAuth Token (Entry)
- Counter ID (Entry)
- Login (Entry)
- Даты начала и конца (Entry)
- Тип отчета (Combobox)

#### Списки метрик
- Доступные метрики (Listbox)
- Выбранные метрики (Listbox)
- Кнопки управления метриками

#### Дополнительные элементы
- Тип атрибуции (Combobox)
- Кнопка выполнения запроса
- Статусная строка
- Прогресс-бар

### Обработка событий
- Валидация ввода
- Обработка ошибок
- Отображение прогресса
- Контекстное меню

### Особенности реализации
- Асинхронная загрузка данных
- Сохранение состояния приложения
- Защита от некорректного ввода
- Информативные сообщения об ошибках

## API Logic (api_logic.py)

### Используемые библиотеки
- `requests` - для HTTP-запросов к API Яндекс.Метрики
- `pandas` - для обработки и сохранения данных
- `datetime` - для работы с датами
- `logging` - для ведения логов
- `json` - для работы с JSON-данными

### Основные функции

#### Работа с API
- `validate_token(token)` 
  - Проверка валидности OAuth токена
  - Отправка тестового запроса к API

- `get_available_metrics(report_type='visits')`
  - Получение списка доступных метрик
  - Кеширование списка для оптимизации

- `validate_fields(fields, report_type='visits')`
  - Проверка корректности выбранных метрик
  - Сопоставление с доступными метриками

#### Создание и обработка запросов
- `create_log_request(token, counter_id, fields, date1, date2, attribution)`
  - Формирование запроса к Logs API
  - Установка параметров запроса в URL и теле запроса
  - Поддержка двух форматов полей (строка и список)
  - Обработка ответа API

- `check_report_status(token, counter_id, request_id)`
  - Проверка статуса подготовки отчета
  - Обработка различных состояний

- `download_report(token, counter_id, request_id)`
  - Загрузка готового отчета
  - Обработка частей отчета

#### Обработка данных
- `format_date(date_str)`
  - Преобразование различных форматов дат
  - Поддержка специальных значений (today, yesterday, NdaysAgo)

- `save_to_csv(data, filename)`
  - Сохранение данных в CSV формат
  - Настройка кодировки и разделителей

### Обработка ошибок
- Валидация всех входных параметров
- Проверка ответов API
- Обработка сетевых ошибок
- Логирование проблем

### Константы
- `ATTRIBUTION_TYPES` - поддерживаемые типы атрибуции
- `API_BASE_URL` - базовый URL API Яндекс.Метрики
- `DEFAULT_TIMEOUT` - таймаут для запросов

### Особенности реализации
- Использование сессий для оптимизации HTTP-запросов
- Кеширование списка метрик
- Двойная передача параметров (URL + тело запроса)
- Поддержка больших отчетов через постраничную загрузку
- Безопасная обработка чувствительных данных
- Корректная обработка форматов полей

## Поддерживаемые типы отчетов

### Visits (посещения)
- Метрики с префиксом `ym:s:`
- Данные на уровне посещений сайта

### Hits (просмотры)
- Метрики с префиксом `ym:pv:`
- Данные на уровне отдельных просмотров страниц

## Форматы дат
- `today` - текущая дата
- `yesterday` - вчерашняя дата
- `NdaysAgo` - N дней назад (например: 7daysAgo)
- `YYYY-MM-DD` - конкретная дата

## Обработка ошибок
- Валидация входных данных
- Обработка ошибок API
- Логирование операций
- Информативные сообщения пользователю

## Логирование
- Ведется лог операций в файле app_debug.log
- Уровень логирования: DEBUG
- Записываются все важные события и ошибки

## Безопасность
- Сохранение чувствительных данных локально
- Безопасная обработка токенов
- Защита от некорректного ввода

### API Documentation References

#### Основная документация
- [Общая документация Logs API](https://yandex.ru/dev/metrika/doc/api2/logs/intro.html)
- [Справочник API](https://yandex.ru/dev/metrika/doc/api2/reference/reference.html)

#### Используемые методы API
- [Создание запроса логов (createLogrequest)](https://yandex.ru/dev/metrika/doc/api2/logs/queries/createlogrequest.html)
- [Получение информации о запросе (getLogrequest)](https://yandex.ru/dev/metrika/doc/api2/logs/queries/getlogrequest.html)
- [Скачивание части логов (downloadLogs)](https://yandex.ru/dev/metrika/doc/api2/logs/downloads/download.html)
- [Очистка запроса логов (cleanLogrequest)](https://yandex.ru/dev/metrika/doc/api2/logs/queries/clean.html)

#### Справочники
- [Список доступных полей](https://yandex.ru/dev/metrika/doc/api2/logs/fields/visits.html)
- [Параметры визитов](https://yandex.ru/dev/metrika/doc/api2/logs/fields/visits.html)
- [Параметры просмотров](https://yandex.ru/dev/metrika/doc/api2/logs/fields/hits.html)

#### Авторизация
- [Получение OAuth-токена](https://yandex.ru/dev/metrika/doc/api2/intro/authorization.html)
- [Права доступа](https://yandex.ru/dev/metrika/doc/api2/intro/access.html)

#### Ограничения
- [Квоты и ограничения](https://yandex.ru/dev/metrika/doc/api2/logs/restrictions.html)
- [Формат дат](https://yandex.ru/dev/metrika/doc/api2/logs/queries/createlogrequest.html#dates)

## Лицензия
MIT License

## Авторы
[Ваше имя/организация]

## Поддержка
При возникновении проблем создавайте issue в репозитории проекта.